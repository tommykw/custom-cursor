<!DOCTYPE html>
<html>
<head>
    <title>Eye Tracking Test</title>
    <style>
        body {
            width: 800px;
            height: 600px;
        }
        .test-target {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: red;
            transform: translate(-50%, -50%);
        }
        #debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="debug-info"></div>
    <script src="face-api.min.js"></script>
    <script>
        // Initialize face-api.js before webgazer
        async function initializeFaceAPI() {
            try {
                // Check if face-api.js is loaded
                if (typeof faceapi === 'undefined') {
                    throw new Error('face-api.jsが読み込まれていません');
                }

                const modelPath = chrome.runtime.getURL('models');
                console.log('顔認識モデルを読み込んでいます...');
                
                // Show loading status
                const statusDiv = document.createElement('div');
                statusDiv.id = 'loading-status';
                statusDiv.style.padding = '20px';
                statusDiv.textContent = '顔認識モデルを読み込んでいます...';
                document.body.appendChild(statusDiv);
                
                try {
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(modelPath),
                        faceapi.nets.faceLandmark68Net.loadFromUri(modelPath)
                    ]);
                    console.log('顔認識モデルの読み込みが完了しました');
                    statusDiv.textContent = '顔認識モデルの読み込みが完了しました';
                    return true;
                } catch (modelError) {
                    throw new Error('顔認識モデルの読み込みに失敗しました: ' + modelError.message);
                }
            } catch (error) {
                console.error('顔認識モデルの読み込みに失敗しました:', error);
                // Update or create error display
                const statusDiv = document.getElementById('loading-status') || document.createElement('div');
                statusDiv.style.color = 'red';
                statusDiv.style.padding = '20px';
                statusDiv.textContent = error.message;
                if (!statusDiv.parentNode) {
                    document.body.appendChild(statusDiv);
                }
                return false;
            }
        }

        // Initialize tracking with proper error handling
        async function initializeTracking() {
            try {
                const statusDiv = document.getElementById('loading-status') || document.createElement('div');
                statusDiv.id = 'loading-status';
                statusDiv.style.padding = '20px';
                if (!statusDiv.parentNode) {
                    document.body.appendChild(statusDiv);
                }

                // Initialize face-api.js first
                statusDiv.textContent = '顔認識システムを初期化中...';
                if (!await initializeFaceAPI()) {
                    throw new Error('顔認識モデルの読み込みに失敗しました');
                }
                
                // Load and initialize webgazer
                statusDiv.textContent = '視線追跡システムを読み込み中...';
                const webgazerScript = document.createElement('script');
                webgazerScript.src = chrome.runtime.getURL('webgazer.js');
                
                await new Promise((resolve, reject) => {
                    webgazerScript.onload = async () => {
                        try {
                            if (typeof window.initWebGazer !== 'function') {
                                throw new Error('WebGazerが正しく読み込まれていません');
                            }
                            statusDiv.textContent = '視線追跡システムを初期化中...';
                            const webgazer = await window.initWebGazer();
                            statusDiv.textContent = '視線追跡の初期化が完了しました';
                            console.log('視線追跡の初期化が完了しました');
                            resolve();
                        } catch (err) {
                            reject(new Error('視線追跡の初期化に失敗しました: ' + err.message));
                        }
                    };
                    webgazerScript.onerror = () => reject(new Error('webgazer.jsの読み込みに失敗しました'));
                    document.body.appendChild(webgazerScript);
                });
            } catch (err) {
                console.error(err.message);
                // Update status div with error
                const statusDiv = document.getElementById('loading-status');
                if (statusDiv) {
                    statusDiv.style.color = 'red';
                    statusDiv.textContent = err.message;
                }
            }
        }

        // Start initialization when the page loads
        document.addEventListener('DOMContentLoaded', initializeTracking);
    </script>
</body>
</html>
