<!DOCTYPE html>
<html>
<head>
    <title>Eye Tracking Test</title>
    <style>
        body {
            width: 800px;
            height: 600px;
        }
        .test-target {
            position: fixed;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: red;
            transform: translate(-50%, -50%);
        }
        #debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div id="debug-info"></div>
    <script src="face-api.min.js"></script>
    <script>
        // Initialize face-api.js before webgazer
        async function initializeFaceAPI() {
            try {
                const modelPath = chrome.runtime.getURL('models');
                console.log('顔認識モデルを読み込んでいます...');
                
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(modelPath),
                    faceapi.nets.faceLandmark68Net.loadFromUri(modelPath)
                ]);
                console.log('顔認識モデルの読み込みが完了しました');
                return true;
            } catch (error) {
                console.error('顔認識モデルの読み込みに失敗しました:', error);
                return false;
            }
        }

        // Initialize tracking with proper error handling
        async function initializeTracking() {
            try {
                // Initialize face-api.js first
                if (!await initializeFaceAPI()) {
                    throw new Error('顔認識モデルの読み込みに失敗しました');
                }
                
                // Load and initialize webgazer
                const webgazerScript = document.createElement('script');
                webgazerScript.src = chrome.runtime.getURL('webgazer.js');
                
                await new Promise((resolve, reject) => {
                    webgazerScript.onload = async () => {
                        try {
                            const webgazer = await window.initWebGazer();
                            console.log('視線追跡の初期化が完了しました');
                            resolve();
                        } catch (err) {
                            reject(new Error('視線追跡の初期化に失敗しました: ' + err.message));
                        }
                    };
                    webgazerScript.onerror = () => reject(new Error('webgazer.jsの読み込みに失敗しました'));
                    document.body.appendChild(webgazerScript);
                });
            } catch (err) {
                console.error(err.message);
                // Display error to user
                const errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.style.padding = '20px';
                errorDiv.textContent = err.message;
                document.body.appendChild(errorDiv);
            }
        }

        // Start initialization when the page loads
        document.addEventListener('DOMContentLoaded', initializeTracking);
    </script>
</body>
</html>
